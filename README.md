# aspire92 ASP.NET Aspire 9.2 with Docker Compose publish and local stack accessible via https

## asire CLI publish

The aspire release 9.2 releases (in preview) the publish command for Docker Compose. [Official release link](https://devblogs.microsoft.com/dotnet/dotnet-aspire-92-is-now-available-with-new-ways-to-deploy/#publish-to-docker-compose-with-your-first-publisher-integration)

While this works well, it is only configured to work with http (and not https) out of the box. To mimic the live stack (that typically runs on https), we need to add a few things to the docker-compose.yml file.

## Local context and objectives

- Developer works on Windows 11 with WSL2 and Podman Desktop.
- Docker CE is installed on WSL2.

The target live enviroment consists of several hosts written in .net and are currently deployed with manually crafted docker-compose files. The goal is to create a local development environment that mimics the live environment as closely as possible. And as automated as possible.

For the example we find the starter app, with an extra 2 hosts

- another web project 
- yarp reverse proxy to route traffic to the web projects and off load the ssl termination from the web projects.

## Prerequisites

- Docker Desktop or Podman Desktop installed and running
- And / or Docker CE installed on Linux / WSL2
- dotent 9.0 SDK installed
- aspire cli preview installed
- Your aspire project with host configurations

## Getting started

1. Clone the repository
2. Open a terminal and navigate to the project directory
3. Adjust your domain names in the appsettings.json file in the yarpreverseproxy project. 
4. Create the yarp certificate with the provided _Powershell_ script. [Create yarp certificate](CCreateSelfSignedCertDev.ps1)
   1. Ensure the password matches the one specified in your Dockerfile (P@ssw0rd!) of the yarp project.
5. Copy the certificate to `./src/certs/ ` (on wsl2 this is `/mnt/x/repos/samples/aspire92/src/certs/` where x/repose/samples/aspire92 is the path to the project on your host machine)
6. Trust the certifacate on both the host and the container.

### On Windows

- Open the yarp-cert.pfx file and import it into the Trusted Root Certification Authorities store:
- Double-click the .pfx file.
- Follow the import wizard and select the Trusted Root Certification Authorities store.

### On Ubuntu

```bash
openssl pkcs12 -in yarp-cert.pfx -clcerts -nokeys -out yarp-cert.crt

sudo cp yarp-cert.crt /usr/local/share/ca-certificates/
sudo update-ca-certificates
```

7. Update your hosts file to match the domain names in the appsettings.json file in the yarp project. 

   1. Add the following lines to your hosts file (C:\Windows\System32\drivers\etc\hosts)

    `127.0.0.1 bpc-dev.localhost.dev`

    `127.0.0.1 sample-dev.localhost.dev`

    2 On wsl2/linux, the hosts file is located at `/etc/hosts`, add the same lines as above.

8. Build and run the project with docker compose

    ``` bash
    docker compose up --build
    ```

### Key difference between the docker-compose.yml that is generated by the aspire cli and the one in this repository

Generated by the aspire cli:

```yaml
    image: "${YARP_IMAGE}"
    build:
      context: ../../
      dockerfile: ./src/aspire92.YarpProxy/Dockerfile
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"
      services__apiservice__http__0: "http://apiservice:8000"
      services__webfrontend__http__0: "http://webfrontend:8004"
      services__bis-bpc-webhost-net9__http__0: "http://bis-bpc-webhost-net9:8008"
      ASPNETCORE_URLS: "http://+:80;https://+:443"
    ports:
      - "443:443"
      - "80:80"
    depends_on:
      apiservice:
        condition: "service_started"
      webfrontend:
        condition: "service_started"
      bis-bpc-webhost-net9:
        condition: "service_started"
    networks:
      - "aspire"

```

This was added:

```yaml
    build:
      context: ../../
      dockerfile: ./src/aspire92.YarpProxy/Dockerfile
```

This was changed:

```yaml
    ports:
      - "443:443"
      - "80:80"
```

This was added:

```yaml
    environment:
      ASPNETCORE_URLS: "http://+:80;https://+:443"
```

~~`HTTP_PORTS: "8012"`~~ was deleted.
